name: Test Image Generation

on:
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_prompt:
        description: 'Test prompt for image generation'
        required: false
        default: 'A beautiful sunset over mountains, digital art'

jobs:
  test-huggingface:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests notion-client
    
    - name: Test Hugging Face API Connection
      env:
        HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
      run: |
        python3 -c "
        import os
        import requests
        
        token = os.environ.get('HUGGINGFACE_TOKEN')
        if not token:
            print('âŒ HUGGINGFACE_TOKEN not set')
            exit(1)
        
        print('ğŸ”‘ Testing token...')
        response = requests.get(
            'https://huggingface.co/api/whoami-v2',
            headers={'Authorization': f'Bearer {token}'},
            timeout=10
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f'âœ… Token valid for user: {data.get(\"name\", \"Unknown\")}')
        else:
            print(f'âŒ Token validation failed: {response.status_code}')
            exit(1)
        "
    
    - name: Test FLUX.1-schnell Image Generation
      env:
        HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
      run: |
        python3 -c "
        import os
        import requests
        import time
        from datetime import datetime
        
        token = os.environ.get('HUGGINGFACE_TOKEN')
        model_url = 'https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell'
        
        headers = {
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }
        
        prompt = '${{ github.event.inputs.test_prompt }}' or 'A beautiful sunset over mountains, digital art'
        
        # FLUX.1-schnell optimized parameters
        payload = {
            'inputs': prompt,
            'parameters': {
                'num_inference_steps': 4,
                'guidance_scale': 0.0,
                'width': 1024,
                'height': 1024,
                'max_sequence_length': 256
            }
        }
        
        print(f'ğŸ¨ Generating high-quality image with FLUX.1-schnell: {prompt}')
        print('â³ This should be much faster and better quality than before!')
        
        try:
            response = requests.post(model_url, headers=headers, json=payload, timeout=90)
            print(f'ğŸ“Š Response status: {response.status_code}')
            
            if response.status_code == 200:
                print('ğŸ‰ High-quality image generated successfully with FLUX.1-schnell!')
                
                # Save test image
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                filename = f'flux_test_{timestamp}.png'
                
                os.makedirs('images', exist_ok=True)
                with open(f'images/{filename}', 'wb') as f:
                    f.write(response.content)
                
                print(f'ğŸ’¾ Image saved as: images/{filename}')
                print(f'ğŸ“ Image size: {len(response.content)} bytes')
                
            elif response.status_code == 503:
                print('â³ FLUX.1-schnell model is loading, waiting 30 seconds and retrying...')
                time.sleep(30)
                
                response = requests.post(model_url, headers=headers, json=payload, timeout=90)
                if response.status_code == 200:
                    print('ğŸ‰ High-quality image generated successfully on retry!')
                    
                    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                    filename = f'flux_test_{timestamp}.png'
                    
                    os.makedirs('images', exist_ok=True)
                    with open(f'images/{filename}', 'wb') as f:
                        f.write(response.content)
                    
                    print(f'ğŸ’¾ Image saved as: images/{filename}')
                else:
                    print(f'âŒ Retry failed: {response.status_code}')
                    exit(1)
            else:
                print(f'âŒ Error: {response.status_code}')
                print(f'ğŸ“ Response: {response.text}')
                exit(1)
                
        except Exception as e:
            print(f'âŒ Error: {e}')
            exit(1)
        "
    
    - name: Upload Generated Images
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: generated-images
        path: images/
        retention-days: 7
    
    - name: Test Summary
      run: |
        echo "ğŸ¯ Test Summary:"
        echo "âœ… Hugging Face API connection successful"
        echo "âœ… FLUX.1-schnell image generation working"
        echo "ğŸš€ Your system is ready to process waiting posts with high-quality images!"
        echo ""
        echo "ğŸ¨ FLUX.1-schnell Benefits:"
        echo "â€¢ Much better image quality than Stable Diffusion XL"
        echo "â€¢ Faster generation (4 steps vs 30 steps)"
        echo "â€¢ Better prompt following"
        echo "â€¢ Completely free with Apache 2.0 license"
        echo ""
        echo "ğŸ“‹ How it works:"
        echo "1. Looks for posts with Status='Waiting' and Content='Picture'"
        echo "2. Generates high-quality images using FLUX.1-schnell"
        echo "3. Saves image link to Link column"
        echo "4. Changes Status from 'Waiting' to 'Pending'" 